---
title: "regression_part_result"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, messages = FALSE)
```
## Method
To figure out which factors leads the differences of condo’s price among different neighborhoods, we may need to check (1) the relationship between all factors and condos’ price, and (2) which significant factors have differences between expensive neighborhoods and general neighborhoods.

Firstly, we will figure out which attributes have a correlation with condo’s price. The simplest approaches is checking the differences of condo’s price group by these factors.  For this case, we split our dataset into different sub-groups based on the values of attributes, and check the average condo’s price over each sub-groups. However, the approach may not be enough reliable and require stronger statistical concept to support that. Thus, we decide to use regression model on that to check whether there are any statistically significant relationships between these coefficients and price of condo. The regression formula we will fit would be: $Y=BX+\beta_0$ where Y denote the price per square meter of condo, X denote all related factors of these condo and B & $\beta_0$ are the parameters of fitted model. Cause there are lots of factors, we should filter some based on our own knowledge and extra test before we use backward selection to fit the best model.

Secondly, it’s necessary to check whether these coefficients have differences between expensive neighborhoods and other general neighborhoods. For this case, we will use Wilcoxon test, which is one of statistical tool to test whether there are differences between two groups, to check that.

## Result
Firstly, we would like to show some interesting factors that may lead differences in condo's price by our knowledge before we start a regression approach. We decide to check (1) whether include gym or not, (2) whether include pet restriction or not, and (3) age of the building to have a quick view. We will split dataset based on these factors seperately and show how the condo's price make different over different subgroups.
```{r setup2, include=FALSE, messages = FALSE}
# This part is set-up code
library(tidyverse)
library(pander)
library(tidyr)
library(gridExtra)
library(grid)
library(plyr)
library(magrittr)

condo.path = "../data/clean_condos_info.csv"
geo.path = "../data/demographics.csv"
condos <- read_csv(condo.path)
areas <- read.csv(geo.path)
condos <- condos %>%
  mutate(area=location_area) %>%
  select(-c("tax_2021", #taxes are dependent on property price
            "amenity_lst", #already extracted relevant data in other columns
            "size_range", #created a size_range_lvl variable instead
            "address", #not relevant for regression
            "corp_num", #??
            "location_area", #changed name to area
            "size_range_level",
            "maintenance_fees"
  )) %>%
  mutate(exposure_EW = as.integer(as.logical(exposure=="EW"))) %>%
  mutate(age_of_building = as.integer(age_of_building)) %>%
  mutate(price_per_sqm = round(price/actual_size))

areas <- areas %>%
  mutate_at(vars(-area, -avg_household_income,-avg_individual_income,-avg_children_per_household,-total_individuals),
            .funs=funs(. * 100)) %>%
  mutate(X0_to_19 = X0_to_4+X5_to_9+X10_to_14+X15_to_19) %>%
  mutate(X65_plus = X65_to_79 + X80_plus) %>%
  mutate(house = single_detached + semi_detached + duplex + row_houses) %>%
  select(-c("other", "multi_person", "total_individuals", "renters", "X0_to_19", "other.1", 
            "trade_certificate", "single_detached", "semi_detached", "duplex", "row_houses", "house", 
            "children_0", "children_1", "children_2", "children_3_plus", "X0_to_4", "X5_to_9", "X10_to_14", "X15_to_19",
            "X65_to_79", "X80_plus"))

all.info <- condos %>%
  merge(areas, by="area") %>%
  select(-c("price", "actual_size"))
```

```{r basic_plot1, echo=FALSE}
gym <- c("yes","no")

condos %>%
  mutate(include_gym=ifelse(include_gym==1,"yes","no")) %>%
  ggplot(aes(y = price, x = actual_size, colour =as.factor(include_gym), group=include_gym)) +
  scale_color_brewer(palette ="Spectral", name="Whether include gym", breaks=gym) +
  geom_smooth(formula = y ~ x, method = "lm", se= F) +
  labs(title="Relationship between Price and Size", x="Size(sqm)", y="Price") + 
  theme_classic() +
  theme(plot.title = element_text(hjust = 0.5, face = "bold")) 
```

Figure 2.1 : The relationship between price and size on include_gym group and not_include_gym group

From this plot, we can say that if the condo include gym, then the price is generally higher than these without gym. 

```{r basic_plot2, warning=FALSE, messages = FALSE}
indoor_pool <- c("yes","no")

condos %>%
  mutate(include_indoor_pool=ifelse(include_indoor_pool==1,"yes","no")) %>%
  ggplot(aes(y = price, x = actual_size, colour =as.factor(include_indoor_pool), group=include_indoor_pool)) +
  scale_color_brewer(palette ="Spectral", name="Whether have indoor pools", breaks=indoor_pool) +
  geom_smooth(formula = y ~ x, method = "lm", se= F) +
  labs(title="Relationship between Price and Size", x="Size(sqm)", y="Price") + 
  theme_classic() +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))

```

Figure 2.2 : The relationship between price and size on include_pet_restriction group and not_include_pet_restriction group

From this plot, we can say that if the condo include pet restrictions, then the price is generally higher than these without pet restirctions but the differences is not really much as we expected.

```{r basic_plot3, warning=FALSE, messages = FALSE}
age_range <- c("new", "general", "old")

condos %>%
  mutate(age_range_of_building = case_when(
    age_of_building <= 8 ~ "new",
    age_of_building <= 25 & age_of_building > 8 ~ "general",
    age_of_building >25 ~ "old"
  )) %>%
  ggplot(aes(y = price, x = actual_size, colour =as.factor(age_range_of_building), group=age_range_of_building)) +
  scale_color_brewer(palette ="Spectral", name="Age of buildings", breaks=age_range) +
  geom_smooth(formula = y ~ x, method = "lm", se= F) +
  labs(title="Relationship between Price and Size", x="Size(sqm)", y="Price") + 
  theme_classic() +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))
```

Figure 2.3 : The relationship between price and size on new buildings, general buildings and old buildings

From this plot, we can easily conclude that younger building will have a general more expensive price compared with older buildings.

However, these plots just give us a direct relationship between condo's price and these factors and even not do control variables. Thus, the result is not reliable but it just give us a basic idea on what we are looking for before we fit a model to find out the statistically relationship between these factors and condo of price.

But for our dependent variable, Y, we use price per square meter instead of price as previously mentioned. We use all factors(including condo's and neighborhoods') as independent variables. 

```{r regression}
# These dropped factors are filtered by extra check
data2 <- all.info %>% 
  select(-c("exposure", "num_amenities", "include_rooftop_deck", "include_visitor_parking", "include_rec_room", 
            "include_bbq_permitted", "include_meeting_room", "include_public_transit", "include_guest_suites", "avg_individual_income",
            "avg_household_income","include_party_room", "include_indoor_pool", "include_media_room", "ensuite_laundry", "area", "X", 
            "X20_to_34", "X35_to_49", "X50_to_64", "include_security_system", "parking_type", "locker", 
            "heating_type", "property_type", "outdoor_space",
            "french", "min_nan_chaochow_teochow_fukien_taiwanese", "vietnamese", "english", "cantonese", "mandarin", "latvian", "russian",
            "spanish", "other.2"))
sqm2 <- lm(formula = price_per_sqm ~ ., data2)
backward_selection_4 <- step(sqm2, trace = 0)
summary(backward_selection_4)
```

Summary 1: The regression model which we fitted from backward selection based on formula $Y = BX+\beta_{0}$

This summary included all parameters and their p-values which can help us to find which factors are significant to determine the condo's price. For these percentage coefficients, we drop one coefficient for each type of percentage to eliminate correlation between these percentage. As we noticed, there are some interesting findings from this model. 

Firstly, the parameters for percentage of french-only speakers is really large compared with other parameters. That's due to the fact that all neighborhoods have a really small proportions for french-only speakers and thus leading the large parameters. 

Secondly, for exposures, we find out the condo with exposure East-West will leads a general high price per square meters compared with other exposures. But we check the dataset and there is only 7 observations for condo with exposure East-West thus it may be outliers but we cannot correct it unless we can have more dataset.

At the end, we decide to check: (1) include_pet_restriction, (2) include_security_guard, (3) include_gym (4) age of buildings for condos' coefficients, and (5) French-opler speaker proportion, (6) English-and-French bilingual speaker percentage, (7) single person property percentage (8) different education levels, (9) average children number per household, (10) owners proportion for neighborhoods' coefficients.

```{r test1, include=FALSE}
areas_ordered <- condos %>%
  group_by(area) %>%
  dplyr::summarise(mean = mean(price_per_sqm, na.rm=TRUE)) %>%
  arrange(desc(mean)) %>%
  .[['area']]

expensive_area_condos <- all.info %>%
  filter(area %in% areas_ordered[1:5])
non_expensive_area_condos <- all.info %>%
  filter(area %in% areas_ordered[6:23])
wilcox.test(expensive_area_condos$include_pet_restriction, non_expensive_area_condos$include_pet_restriction)
wilcox.test(expensive_area_condos$include_security_guard, non_expensive_area_condos$include_security_guard)
wilcox.test(expensive_area_condos$include_gym, non_expensive_area_condos$include_gym)

wilcox.test(expensive_area_condos$owners, non_expensive_area_condos$owners)
wilcox.test(expensive_area_condos$en_and_fr, non_expensive_area_condos$en_and_fr)
wilcox.test(expensive_area_condos$post_graduate_degree, non_expensive_area_condos$post_graduate_degree)
wilcox.test(expensive_area_condos$avg_children_per_household,non_expensive_area_condos$avg_children_per_household)
wilcox.test(expensive_area_condos$single_person, non_expensive_area_condos$single_person)
```


After test differences, we may only need to focus on these parameters: (1) include_pet_restriction, (2) include_security_guard, (3) include_gym (4) age of buildings for condos' coefficients, and (5) French-opler speaker proportion, (6) English-and-French bilingual speaker percentage, (7) single person property percentage (8) average children number per household, (9) owners proportion for neighborhoods' coefficients.

```{r result_table1}
field = c("average_children", "age_of_building",  "include_gym", "include_pet_restrictions", "include_security_guard",
          "multiple family in %", "french-only speaker in %", "English-and-French Bilingual speaker in %", "owners in %")
expensive_areas = c(mean(expensive_area_condos$avg_children_per_household), mean(expensive_area_condos$age_of_building, na.rm=TRUE),
                    mean(expensive_area_condos$include_gym), mean(expensive_area_condos$include_pet_restriction),mean(expensive_area_condos$include_security_guard),
                    mean(expensive_area_condos$multi_family), mean(expensive_area_condos$fr_only),
                    mean(expensive_area_condos$en_and_fr), mean(expensive_area_condos$owners))
non_expensive_areas = c(mean(non_expensive_area_condos$avg_children_per_household), mean(non_expensive_area_condos$age_of_building,na.rm=TRUE),
                        mean(non_expensive_area_condos$include_gym), mean(non_expensive_area_condos$include_pet_restriction), mean(non_expensive_area_condos$include_security_guard),
                        mean(non_expensive_area_condos$multi_family), mean(non_expensive_area_condos$fr_only), mean(non_expensive_area_condos$en_and_fr),
                        mean(non_expensive_area_condos$owners))
unit_effect_on_condo_price = c(-5142.3736, -12.3639, 41.3866, -67.0026, 35.8358,30337.2293, 34555.4002, 5087.2418, 779.8686)
total_effect_value = round((expensive_areas - non_expensive_areas) * unit_effect_on_condo_price, digits = 4)
as.table(cbind(field, expensive_areas, non_expensive_areas, unit_effect_on_condo_price, total_effect_value)[2:5,])
```

Table 2.1: The Result Table for condos' factors

This table provide information about how expensive areas and general areas make differences on these condos' factor and how they effect the differences on condo's price per square meters between expensive neighborhoods and others. The first column is the average value of expensive neighborhoods, the second column is the average value of general neighborhoods, and the 3rd column is coefficient's estimated parameters in our fitted model which defined as unit effect of this coefficient on condo's price per square meters. We will talk about result with Table 2.2 in next paragraph.


```{r result_table2}
as.table(cbind(field, expensive_areas, non_expensive_areas, unit_effect_on_condo_price, total_effect_value)[c(1,6:9),])
```

Table 2.2: The Result Table for neighborhoods' factors

This table provide information about how expensive areas and general areas make differences on these neighborhoods' factor and how they effect the differences on condo's price per square meters between expensive neighborhoods and others. The structure of Table 2.2 is same as Table 2.1 but compared with Table 2.1, the Table 2.2 have much larger effect on differences values. Thus, we can only discuss results from Table 2.2 in details.

For this table, the most significant variable is the percentage of owner, and expensive areas have ~56.4% of residence are owners when non-expensive areas have ~40.2% and as the estimated parameter for owner percentage is 779.8686 thus the differences of owner proportions leads a $\$$12572.1347 more on price per square meters in expensive neighborhoods compared with general neighborhoods. And similar with french-only speaker proportion but the resulted total effect is negative (-2382.7691) but it may be not reliable result cause the french-only speaker proportion is really small(0.056% and 0.1251%) and may not be a good indicator to denote the differences between expensive areas and non-expensive areas. The similar idea can also apply to multiple family property proportion. However, the English-and-French Bilingual speaker proportion is really good indicator and the differences on this field make expensive areas have $\$$4205.8506 more on price per square meters compared with other neighborhoods. The other interesting thing is that there is negative relationship between average children per household and condo's price and the total effect value is $\$$433.1169.

To conclude for this part, we can say (1) the percentage of owner, (2) average children number, (3) English-and-French Biligual speaker proportion may be the factor that make expensive neighborhoods expensive but just noticed for our project, we only show correlation instead of causality.
